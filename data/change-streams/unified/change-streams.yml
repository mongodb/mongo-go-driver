description: "change-streams"
schemaVersion: "1.0"
runOnRequirements:
  - minServerVersion: "3.6"
  - topologies: [ replicaset, sharded-replicaset ]
createEntities:
  - client:
      id: &client0 client0
  - database:
      id: &database0 database0
      client: *client0
      databaseName: *database0
  - collection:
      id: &collection0 collection0
      database: *database0
      collectionName: *collection0
initialData:
  - collectionName: *collection0
    databaseName: *database0
    documents: []
tests:
  - description: "Test array truncation"
    runOnRequirements:
      - minServerVersion: "4.7"
        topologies: [replicaset]
    operations:
      - name: insertOne
        object: *collection0
        arguments:
          document: {
            "_id": 1,
            "a": 1,
            "array": ["foo", {"a": "bar"}, 1, 2, 3]
          }
      - name: createChangeStream
        object: *collection0
        arguments:
          pipeline: []
        saveResultAsEntity: &changeStream0 changeStream0
      - name: updateOne
        object: *collection0
        arguments:
          filter: {
            "_id": 1
          }
          update: [
            {
              "$set": {
                "array": ["foo", {"a": "bar"}]
              }
            }
          ]
      - name: iterateUntilDocumentOrError
        object: *changeStream0
        expectResult: {
          "operationType": "update",
          "ns": {
            "db": "database0",
            "coll": "collection0"
          },
          # It is up to the MongoDB server to decide how to report a change.
          # This expectation is based on the current MongoDB server behavior.
          # Alternatively, we could have used a set of possible expectations of which only one
          # must be satisfied, but the unified test format does not support this.
          "updateDescription": {
            "updatedFields": {},
            "removedFields": [],
            "truncatedArrays": [
              {
                "field": "array",
                "newSize": 2
              }
            ]
          }
        }
  - description: "Test unknown operationType MUST NOT err"
    operations:
      - name: createChangeStream
        object: *collection0
        arguments:
          # using $project to simulate future changes to ChangeStreamDocument structure
          pipeline: [ { $project: { operationType: "addedInFutureMongoDBVersion", ns: 1 } } ]
        saveResultAsEntity: &changeStream0 changeStream0
      - name: insertOne
        object: *collection0
        arguments:
          document: { "_id": 1, "a": 1 }
      - name: iterateUntilDocumentOrError
        object: *changeStream0
        expectResult:
          operationType: "addedInFutureMongoDBVersion"
          ns:
            db: *database0
            coll: *collection0

  - description: "Test newField added in response MUST NOT err"
    operations:
      - name: createChangeStream
        object: *collection0
        arguments:
          # using $project to simulate future changes to ChangeStreamDocument structure
          pipeline: [ { $project: { operationType: 1, ns: 1, newField: "newFieldValue" } } ]
        saveResultAsEntity: &changeStream0 changeStream0
      - name: insertOne
        object: *collection0
        arguments:
          document: { "_id": 1, "a": 1 }
      - name: iterateUntilDocumentOrError
        object: *changeStream0
        expectResult:
          operationType: "insert"
          ns:
            db: *database0
            coll: *collection0
          newField: "newFieldValue"

  - description: "Test new structure in ns document MUST NOT err"
    operations:
      - name: createChangeStream
        object: *collection0
        arguments:
          # using $project to simulate future changes to ChangeStreamDocument structure
          pipeline: [ { $project: { operationType: "insert", "ns.viewOn": "db.coll" } } ]
        saveResultAsEntity: &changeStream0 changeStream0
      - name: insertOne
        object: *collection0
        arguments:
          document: { "_id": 1, "a": 1 }
      - name: iterateUntilDocumentOrError
        object: *changeStream0
        expectResult:
          operationType: "insert"
          ns:
            viewOn: "db.coll"

  - description: "Test modified structure in ns document MUST NOT err"
    operations:
      - name: createChangeStream
        object: *collection0
        arguments:
          # using $project to simulate future changes to ChangeStreamDocument structure
          pipeline: [ { $project: { operationType: "insert", ns: { db: "$ns.db", coll: "$ns.coll", viewOn: "db.coll" } } } ]
        saveResultAsEntity: &changeStream0 changeStream0
      - name: insertOne
        object: *collection0
        arguments:
          document: { "_id": 1, "a": 1 }
      - name: iterateUntilDocumentOrError
        object: *changeStream0
        expectResult:
          operationType: "insert"
          ns:
            db: *database0
            coll: *collection0
            viewOn: "db.coll"

  - description: "Test server error on projecting out _id"
    runOnRequirements:
      - minServerVersion: "4.2"
    operations:
      - name: createChangeStream
        object: *collection0
        arguments:
          pipeline: [ { $project: { _id: 0 } } ]
        saveResultAsEntity: &changeStream0 changeStream0
      - name: insertOne
        object: *collection0
        arguments:
          document: { "_id": 1, "a": 1 }
      - name: iterateUntilDocumentOrError
        object: *changeStream0
        expectError:
          errorCode: 280
          errorCodeName: "ChangeStreamFatalError"
          errorLabelsContain: [ "NonResumableChangeStreamError" ]


  - description: "Test projection in change stream returns expected fields"
    operations:
      - name: createChangeStream
        object: *collection0
        arguments:
          pipeline: [ { $project: { optype: "$operationType", ns: 1, newField: "value" } } ]
        saveResultAsEntity: &changeStream0 changeStream0
      - name: insertOne
        object: *collection0
        arguments:
          document: { "_id": 1, "a": 1 }
      - name: iterateUntilDocumentOrError
        object: *changeStream0
        expectResult:
          optype: "insert"
          ns:
            db: *database0
            coll: *collection0
          newField: "value"